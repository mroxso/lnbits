{% extends "public.html" %} {% block page %}<q-page>
<div class="row q-col-gutter-md justify-center">
  <div class="col-12 col-md-7 col-lg-6 q-gutter-y-md">
    <q-card class="q-pa-lg">
        <q-card-section>
            <div class="chat-container" ref="chatCard">
              <div class="chat-box">
                <div class="chat-messages">
                  <q-chat-message
                    :key="index"
                    v-for="(message, index) in orderMessages"
                    :name="message.pubkey == keys.pubkey ? 'me' : 'customer'"
                    :text="[message.msg]"
                    :sent="message.pubkey == keys.pubkey ? true : false"
                    :bg-color="message.pubkey == keys.pubkey ? 'white' : 'light-green-2'"
                  />
                </div>
              </div>
              <q-card-section>
                <q-form @submit="sendMessage" class="full-width chat-input">
                  <q-input
                    ref="newMessage"
                    v-model="newMessage"
                    placeholder="Message"
                    class="full-width"
                    dense
                    outlined
                  >
                    <template>
                      <q-btn
                        round
                        dense
                        flat
                        type="submit"
                        icon="send"
                        color="primary"
                      />
                    </template>
                  </q-input>
                </q-form>
              </q-card-section>
            </div>
          </q-card-section>
    </q-card>
  </div>
</q-page>
{% endblock %} {% block scripts %}
  <script>
    new Vue({
      el: '#vue',
      mixins: [windowMixin],
      data: function () {
        return {
        newMessage: '',
        showMessages: false,
        messages: {},
        stall: null,
        selectedOrder: null,
        diagonalley: false,
        products: [],
        orders: [],
        user: {
          keys: {},
          orders: {}
        },
        keysDialog: {
          show: false,
          data: {}
        }
        }
      },
      methods: {
        clearMessage: function() {
        this.newMessage = ''
        this.$refs.newMessage.focus()
      },
      clearRestoreKeyDialog: function() {
        this.keysDialog = {
          show: false,
          data: {}
        }
      },
      sendMessage: function() {

        let message = {
          name: this.user.name,
          key: this.user.key,
          msg: this.newMessage
        }
        LNbits.api
          .request('GET', ' ../api/v1/ws/' + self.copilot.id + '/' + message)
          .then(res => {
            this.messages.append = res.data
            this.clearMessage()
          })
          .catch(error => {
            console.log('error', error)
            LNbits.utils.notifyApiError(error)
          })
        
      },
      getMempool() {
        
      },
      initWs: async function () {
        if (location.protocol !== 'http:') {
          localUrl =
            'wss://' +
            document.domain +
            ':' +
            location.port +
            '/api/v1/ws/' + self.copilot.id
        } else {
          localUrl =
            'ws://' +
            document.domain +
            ':' +
            location.port +
            '/api/v1/ws/' + self.copilot.id
        }
        this.ws = new WebSocket(localUrl)
        this.ws.addEventListener('message', async ({data}) => {
          const res = data.toString()
          document.getElementById('text-to-change').innerHTML = res
        })
      },
      },
      created: function(){
        self = this
        self.copilot = JSON.parse(localStorage.getItem('copilot'))
        self.initWs()
      }
    })
  </script>
  {% endblock %}
</div>

